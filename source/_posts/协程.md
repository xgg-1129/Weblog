---
title: 协程
date: 2021-10-15 11:11:49
tags:
- GoLang
- 操作系统
categories:
---
-
<!-- more -->

## 程序运行的上下文

一个程序要真正运行起来，需要两个因素：可执行代码段、数据。体现在CPU中，主要包含以下几个方面： 

1. IP寄存器，用来存储CPU要读取指令的地址 

2. ESP、EBP寄存器：指向当前线程栈的栈顶位置 

3. 其他通用寄存器的内容：包括代表函数参数的rdi、rsi等等。 

4. 线程栈中的内存内容。

## 协程切换的优点

相比线程更加轻量级: 线程的创建和调度都是在内核态，而协程是在用户态完成的; 线程的个数往往受限于CPU核数，线程过多，会造成大量的核间切换。而协程无需考虑这些。

## 协程的分类

1.有栈式和非栈式协程【协程的栈就是线程中的堆区】

2.对称和非对称

3.....还有一些根据调度机制等其他规则分类的协程【有需要再查吧】

## 有栈协程的实现原理

改变线程的部分上下文，也就是复用线程【复用和分层是计算机的重要思想】

## 协程具体的实现方法

目前有如下几种方式来实现协程库。

### 利用ucontext函数族来切换运行时上下文。

Linux下提供了一套函数，叫做ucontext簇函数，可以用来获取和设置当前线程的上下文内容，给用户让渡了一部分控制代码上下文的能力。【简单来说就是ucontext簇函数可以改变当前线程的上下文】
 ucontext_t 中保存的上下文主要包括以下几个部分：
 （1） 运行时各个寄存器的值
 （2） 运行栈（堆就不用保存了，你存不存，他都在那里，不来不去）
 （3） 信号
 基本上有了这些，就可以有效地在用户态保存线程运行现场。

参考资料：

[理解风云有栈协程实现原理](https://zhuanlan.zhihu.com/p/94018082)

[云风版协程库源代码分析](https://www.cnblogs.com/motadou/p/12667166.html)

[云风coroutine协程库源码分析](https://zhuanlan.zhihu.com/p/84935949)

[从ucontext到coroutine](https://www.jianshu.com/p/a96b31da3ab0)

### 利用汇编语言来切换运行时上下文。

参考资料：

[微信开源C++Libco介绍与应用](https://zhuanlan.zhihu.com/p/51078499)

[ 130行C语言实现个用户态线程库](https://www.cnblogs.com/github-Yuandong-Chen/p/6849168.html)

### 利用C语言语法switch-case来实现切换运行时上下文。

参考资料Protothreads

### 利用C语言的setjmp和longjmp

## 协程和IO多路复用结合的优点

【待更】

## GoLang的协程

【待更】