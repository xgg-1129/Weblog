---
title: IPC进程通信
date: 2021-10-16 13:16:39
tags:
- 操作系统
- GoLang
categories:
---
-
<!-- more -->

## 进程

从我们程序员的角度出发，进程是内存中正在运行的一个程序，从操作系统的角度来看，进程就是一个struct结构体，创建和销毁进程也就是创建和销毁一个结构体。【僵尸进程就是一个子进程已经运行完毕调用了exit，但是操作系统没有销毁该结构体的进程，需要父进程给他收尸，这种设计方案能够父进程知道子进程的处于什么状态。】

## 进程通信的原理

每个进程的用户地址空间都是独立的，进程相互间无法感应到彼此的存在，但内核空间是每个进，操作系统负责进程的管理，所以进程之间的通信都是由操作系统系统的服务。**进程通信的方法多种多样，但是所有方法的设计思路都是由操作系统提供一块2个进程可以访问的内存区域**

## 信号

### 信号原理

信号是在软件层次上对中断机制的一种模拟【软中断】，在原理上，一个进程收到一个信号与处理器收到一个中断请求可以说是一样的。信号是异步的，一个进程不必通过任何操作来等待信号的到达，事实上，进程也不知道信号到底什么时候到达。

信号是**进程间通信机制中唯一的异步通信机制**，可以看作是异步通知，通知接收信号的进程有哪些事情发生了。

### 信号来源

(1)程序错误，如非法访问内存，还有除0

【当发生整数除 0 之类的错误时, 硬件会触发中断, 这时操作系统会根据上下文查出是哪个进程不给力了, 然后给这个进程发出一个信号，那我能不能修改这个进程对这个信号的处理方法，然后使得这个程序不报错呀。】

(2)外部信号【硬件来源】，如按下了CTRL+C

(3)通过kill或sigqueue向另外一个进程发送信号





信号是一种异步的通信手段，信号只是一个很小的bit，表明是哪一类信号，**并不是大量的数据交换【这条应该算是缺点吧】**，只起到一个通知的作用。这种通信方式很灵活、效率很高。

信号又分可靠和不可靠的信号，不可靠的信号很会发生信号丢失的情况【一个进程如果有了类型k的待处理信号，接下来如果还受到了类型k的信号，则会将这个信号丢弃】

### GoLang信号的使用

GoLang使用channel来监听信号，对应的API在os/signal

```go
type Signal interface {
	String() string
	Signal() // to distinguish from other Stringers
}
```

## 共享内存

### 共享内存的原理

共享内存的原理是操作系统解除进程间的隔离，修改2个进程的页表，使得它们映射到用一块物理内存，提供了一块共享的**用户态内存**，只需要刚开始时操作系统的介入分配空间，之后就不再需要操作系统的介入，**是最快的IPC通信机制**。

共享内存可以通过mmap映射普通文件（特殊情况下还可以采用匿名映射）机制实现，也可以通过系统V共享内存机制实现【这个机制不会】。

共享内存用来实现进程间共享的、非常庞大的、读写操作频率很高的数据（配合信号量使用）；**这种方式通常适用于多进程间通信。**



### GoLang共享内存

golang不提供使用共享内存来通信的API，都是通过cgo来调用C语言来实现的。使用方法看[这里](https://studygolang.com/articles/10203)

## 消息队列

消息队列我觉得也是共享内存的一种，但是它共享的是一片**内核内存**,消息队列是一块条链表，每个Node是独立的数据单位，每一个数据单位被称为消息体【Pipe中的数据是流数据】。两种模型在操作系统中都常见,消息传递对于交换较少数量的数据很有用，因为无需避免冲突。对于分布式系统，消息传递也比共享内存更易实现。

<img src="/images/thread.png" width="70%"  />



### GoLang消息队列

和共享内存一样，Go不提供封装了消息队列的标准库函数，需要自己用cgo调用。

## 管道

管道同样是操作系统为2个进程提供的一块**半双工内核内存**

无名管道：只能用于父子进程或者兄弟进程之间，需要双方通信时，需要建立起两个管道

有名管道：有名管道是为了解决无名管道只能用于近亲进程之间通信的缺陷而设计的。命名管道是建立在实际的磁盘介质或文件系统（而不是只存在于内存中）上有自己名字的文件，任何进程可以在任何时间通过文件名或路径名与该文件建立联系。为了实现命名管道，引入了一种新的文件类型——FIFO文件（遵循先进先出的原则）。实现一个命名管道实际上就是实现一个FIFO文件。命名管道一旦建立，之后它的读、写以及关闭操作都与普通管道完全相同。虽然FIFO文件的inode节点在磁盘上，但是仅是一个节点而已，文件的数据还是存在于内存缓冲页面中，和普通管道相同。[引自](https://blog.csdn.net/yxtxiaotian/article/details/69568774)

### GoLang管道

API：在os包里

作用：创建命名管道
返回值：
    r *File  管道输出端
	w *File  管道输入端
	err error 可能发生的错误
注意：命名管道的读/写必须同时进行，否则会阻塞到读/写
func Pipe() (r *File, w *File, err error)

## 信号量

信号量主要是用来**保护共享资源**，使得资源在一个时刻只有一个进程（线程）所拥有，**信号量通常配合共享内存一起用，保证共享内存数据的一致性。**
进程可以根据它判定是否能够访问某些共享资源，同时，进程也可以修改该标志。除了用于访问控制外，还可用于进程同步。

信号量有以下两种类型：

- **二值信号量**： 也称互斥信号量，最简单的信号量形式，信号量的值只能取0或1，类似于互斥锁。 注：二值信号量能够实现互斥锁的功能，但两者的关注内容不同。信号量强调共享资源，只要共享资源可用，其他进程同样可以修改信号量的值；互斥锁更强调进程，占用资源的进程使用完资源后，必须由进程本身来解锁。【实现进程互斥】
- **计算信号量**：信号量的值可以取任意非负值（当然受内核本身的约束）。

Socket

不仅是进程间通信，更是主机间通信，分布式开发的首选。【socket对应的是一个文件，进程可以复用一个socket，进程通过socket通信】

<img src="/images/socket.png" width="80%"  />

## 参考资料：

[消息队列和共享内存](http://c.biancheng.net/view/1208.html)

[各种IPC机制的应用场景](https://www.zhihu.com/question/23995948/answer/136236554)

[Linux 进程间通信](https://mp.weixin.qq.com/s/WgZaS5w5IXa3IBGRsPKtbQ)

[理解Linux进程](https://www.kancloud.cn/kancloud/understanding-linux-processes/52163)

