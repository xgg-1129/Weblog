---
title: 内存对齐
date: 2021-10-14 09:48:38
tags: 
- GoLang
- 计算机组成原理
categories:
- 学习

---
-
<!-- more -->

## 内存对齐概述

内存对齐就是将数据对齐到特定内存地址，提升处理器访问数据的速度，许多的体系结构都强制要求特定长度的数据类型进行特定的对齐。[其实这些编译器都会帮助我们完成，如果急着准备面试没必要看这个]

## 1+4+2 = 12 ?

<img src="/images/struct.png" width="40%"  />

## 字

在我们程序员眼中的内存是一块**字节数组**，但是在CPU眼中是一块**字数组**，CPU的总线一次能传输固定大小的数据，这块数据的长度被称为**字长/机器字长**。**字**代表了CPU一次能加工和获取到的数据的最高字节数，字越大，CPU一次就能处理越多的数据。【cpu对访问任意内存字节的操作做了很多处理，例如你想访问的地址为1-8，字为8字节的cpu会进行2次寻址，第一次访问0-7取1-7，第二次访问8-15取7-8，然后将两个部分拼接起来】

## 内存对齐的原因

**平台原因**：不是所有的硬件平台都能访问任意地址上的任意数据的；某些硬件平台只能在某些地址处取某些特定类型的数据，否则抛出硬件异常。

很多 CPU（如基于 Alpha，IA-64，MIPS，和 SuperH 体系的）拒绝读取未对齐数据。当一个程序要求这些 CPU 读取未对齐数据时，这时 CPU 会进入异常处理状态并且通知程序不能继续执行。举个例子，在 ARMMIPS，和 SH 硬件平台上，当操作系统被要求存取一个未对齐数据时会默认给应用程序抛出硬件异常。所以，如果编译器不进行内存对齐，那在很多平台的上的开发将难以进行。那么，为什么这些 CPU 会拒绝读取未对齐数据？是因为未对齐的数据，会大大降低 CPU 的性能。



**性能原因**：数据结构(尤其是栈)应该尽可能地在自然边界上对齐。原因在于，为了访问未对齐的内存，处理器需要作两次内存访问；而对齐的内存访问仅需要一次访问。字节对齐主要是为了提高内存的访问效率。

比如intel 32位cpu，每个总线周期都是从偶地址开始读取32位的内存数据，如果数据存放地址不是从偶数开始，则可能出现需要两个总线周期才能读取到想要的数据，因此需要在内存中存放数据时进行对齐。

## 内存对齐的方法

每种数据类型在不同平台下都有自己的对齐边界，对齐边界规定了数据应该如何内存对齐，它的规则和使用方法有点复杂。【知道了过一阵子也会忘掉，如果有需要再查资料吧】

## 参考资料

[一文轻松理解内存对齐](https://zhuanlan.zhihu.com/p/140063999)

[如何理解 struct 的内存对齐](https://www.zhihu.com/question/27862634/answer/208895189)

