---
title: 函数调用
date: 2021-10-15 13:28:54
tags:
- GoLang
categories:
---
-
<!-- more -->

## GoLang的函数参数传递

C 语言和 Go 语言在设计函数的调用惯例时选择了不同的实现。C 语言同时使用寄存器和栈传递参数，使用 eax 寄存器传递返回值；而 Go 语言使用栈传递参数和返回值。我们可以对比一下这两种设计的优点和缺点：

- C 语言的方式能够极大地减少函数调用的额外开销，但是也增加了实现的复杂度；
  - CPU 访问栈的开销比访问寄存器高几十倍[3](https://draveness.me/golang/docs/part2-foundation/ch04-basic/golang-function-call/#fn:3)；
  - 需要单独处理函数参数过多的情况；
- Go 语言的方式能够降低实现的复杂度并支持多返回值，但是牺牲了函数调用的性能；
  - 不需要考虑超过寄存器数量的参数应该如何传递；
  - 不需要考虑不同架构上的寄存器差异；
  - 函数入参和出参的内存空间需要在栈上进行分配；

Go 语言使用栈作为参数和返回值传递的方法是综合考虑后的设计，选择这种设计意味着编译器会更加简单、更容易维护。

## GoLang的栈帧分配

GoLang采取一次性分配栈帧的方法，采用这种方法的原因是避免协程的函数栈帧越界到其他协程的内存区。

GoLang调用函数时，如果发现新栈帧所需的空间过大，则会在其他区域另外分配一块新的大栈，并把原来的数据拷贝过去，原来的空间被释放。

![image](/images/f.png)

## 总结

函数调用的过程就是往栈里穿参数和返回地址，然后修改ESP和EBP的寄存器，形成新的栈帧，函数调用的时候可以通过新的EBP获取局部变量。